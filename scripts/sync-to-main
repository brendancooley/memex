#!/usr/bin/env bash
set -euo pipefail

# Sync develop branch to main via PR
#
# Usage:
#   ./scripts/sync-to-main           # Create PR from develop â†’ main (interactive)
#   ./scripts/sync-to-main --post    # Run after PR is merged to sync back
#
# Options:
#   -t, --title "..."    PR title (skips prompt)
#   -d, --desc "..."     PR description/summary (skips prompt)

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$REPO_ROOT"

# Defaults
PR_TITLE=""
PR_DESC=""
DEFAULT_TITLE="release: sync develop to main"
DEFAULT_DESC="Periodic sync of develop branch to main."

post_merge() {
    echo "Syncing main back into develop..."
    git checkout develop
    git pull origin develop
    git fetch origin main
    git merge origin/main -m "chore: sync with main"
    git push origin develop
    echo "Done. Branches are aligned."
}

create_pr() {
    echo "Checking branch status..."
    git fetch origin main develop

    # Check if there are commits to sync
    commits=$(git log --oneline origin/main..origin/develop | wc -l | tr -d ' ')
    if [ "$commits" -eq 0 ]; then
        echo "No commits to sync. develop and main are identical."
        exit 0
    fi

    echo "Found $commits commit(s) to sync."
    echo ""
    git log --oneline origin/main..origin/develop
    echo ""

    read -p "Create PR to sync these to main? (y/N) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit 1
    fi

    # Prompt for title if not provided via flag
    if [ -z "$PR_TITLE" ]; then
        read -p "PR title [$DEFAULT_TITLE]: " PR_TITLE
        PR_TITLE="${PR_TITLE:-$DEFAULT_TITLE}"
    fi

    # Prompt for description if not provided via flag
    if [ -z "$PR_DESC" ]; then
        read -p "PR summary [$DEFAULT_DESC]: " PR_DESC
        PR_DESC="${PR_DESC:-$DEFAULT_DESC}"
    fi

    gh pr create --base main --head develop \
        --title "$PR_TITLE" \
        --body "$(cat <<EOF
## Summary

$PR_DESC

## After merging

Run \`./scripts/sync-to-main --post\` to sync main back into develop.

---
Use **"Create a merge commit"** (not squash) to preserve history.
EOF
)"

    echo ""
    echo "PR created. After merging, run:"
    echo "  ./scripts/sync-to-main --post"
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --post)
            post_merge
            exit 0
            ;;
        -t|--title)
            PR_TITLE="$2"
            shift 2
            ;;
        -d|--desc)
            PR_DESC="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

create_pr
